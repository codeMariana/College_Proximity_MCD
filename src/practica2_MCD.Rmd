---
title: "College Proximity: Instrumental Variable"
author: 
  - Mariana Lugo 
  - Lizzy Gamboa´
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Modelación en Ciencia de Datos 
## Variables Instrumentales

Para la elaboración de la práctica se utilizan las siguientes librerías: 
```{r, message=FALSE}
install.packages("AER")
library(AER)
library(dplyr)
library(kableExtra)
library(ggplot2)
library(stats)
library(glmnet)
library(ivreg)
```
Para el ejercicio se utilizan los datos de la encuesta *High School and Beyond* realizada por el Departamento de Educación en 1980, con seguimiento en 1986. La encuesta incluye a estudiantes de aproximadamente 1,100 preparatorias.

# 1. Adjunte el paquete AER y cargue los datos de CollegeDistance.

Se cargan los datos los cuales contienen 4,739 observaciones y 14 variables. Las variables se definen de la siguiente manera:

1. gender: variable categórica que indica el género. 
2. ethnicity: variable categórica que indica la etnia (African-American, Hispanic or other).
3. score: variable numérica de la puntuación del año base de la prueba compuesta . Estas son pruebas de rendimiento que se dan a los estudiantes de último año de secundaria de la muestra.
4. fcollege: variable categórica que indica si el padre es graduado de college. 
5. mcollege: variable categórica que indica si la madre es graduada de college.
6. home: variable categórica que indica si la familia es dueña de la casa.
7. urban: variable categórica que indica si la escuela está en una zona urbana.
8. unemp: variable numérica de la tasa de desempleo del condado en 1980.
9. wage:  variable numérica del salario estatal por hora en la industria manufacturera en 1980.
10. distance: distancia a la 4-year colleg (en 10 millas).
11. tuition: colegiatura promedio de 4-year college estatal (en 1000 USD).
12. education:número de años de educación.
13. income: variable categórica que indica si el ingreso familiar es mayor a 25,000 USD al año.
14. region: variable categórica que indica la región (West u otra)

```{r, echo=FALSE}
data(CollegeDistance)
kable(head(CollegeDistance),booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")
```

# 2. Obtenga una descripción general del conjunto de datos. Específicamente, tome en cuenta que la variable distancia (la distancia a la escuela más cercana en 10 millas) servirá como instrumento en las estimaciones. Utilice un histograma para visualizar la distribución de la distancia

```{r}
summary(CollegeDistance)
hist(CollegeDistance$distance)
ggplot(CollegeDistance, aes(x = distance, fill = urban)) + 
  geom_histogram()

ggplot(CollegeDistance, aes(x = distance, y = urban)) + 
  geom_boxplot()

```

# 3. . Estime dos regresiones cuyos resultados no son confiables debido al problema de selección. Guarde estos resultados para compararlos posteriormente con los obtenidos mediante el enfoque de variables instrumentales aplicado por Card (1993). Estime por ejemplo el modelo:
$$log|wage| = \beta_0 +\beta_1 log|education| + u$$
```{r}
m1<-lm(log(wage)~log(education), CollegeDistance)
summary(m1)

m2<-lm(log(wage)~log(education)+ ethnicity+gender+region+urban, CollegeDistance)
summary(m2)
```


# 4. ¿Por qué se puede utilizar la distancia a la escuela como instrumento? Justifique el motivo por el cual esta variable podría ser utilizada como un instrumento.


# 5. Calcule las correlaciones de la distancia del instrumento con la educación regresora endógena y la variable dependiente salario. ¿Qué parte de la variación en la educación se explica por la regresión de la primera etapa que utiliza la distancia como regresor?

La variación explicada por la educación es la R2 del modelo 1. 

```{r}
install.packages("PerformanceAnalytics")
library(PerformanceAnalytics)

cor_vars<- CollegeDistance %>% select(distance, wage, education)
log_cor_vars<- CollegeDistance %>% mutate(log_wage=log(wage),
                                      log_educ=log(education),
                                      log_dist=log(distance+1)) %>% 
                                      select(c(log_wage, log_educ, log_dist))

chart.Correlation(cor_vars, histogram = TRUE, method = "pearson")
chart.Correlation(log_cor_vars, histogram = TRUE, method = "pearson")
```
# 6. Repita las estimaciones anteriores utilizando IV, es decir, utilice la distancia como un instrumento para la educación en ambas regresiones mediante la función ivreg(). Guarde sus resultados y obtenga los errores estándar robustos para ambos modelos.


```{r}
m3 <- ivreg(wage ~ education | distance,data = CollegeDistance)  
summary(m3)
m2<-lm(log(wage)~log(education)+ ethnicity+gender+region+urban, CollegeDistance)

m4<-ivreg(wage ~ education + ethnicity+gender+region+urban|ethnicity+gender+region+urban+distance,data = CollegeDistance)
summary(m4)
```

